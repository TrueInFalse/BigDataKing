# ClickHouse

> **ClickHouse是为大规模、高并发、秒级查询而生的列式分析型数据库，凭借列存、压缩、并行、容错、物化视图等机制，在PB级数据分析场景中具备极强竞争力。**

##  0. [官方文档](https://clickhouse.com/docs/zh/use-cases)


## 1. 基本概念  
**ClickHouse** 是一款高性能、列式存储的分布式OLAP数据库管理系统，主要用于**大规模数据的实时分析查询**。它由俄罗斯Yandex公司开发，擅长**快速处理PB级数据**，特别适合**写少读多、分析型场景**。

## 2. 核心特性  
- **列式存储**：数据以列为单位存储，查询只读取需要的列，大大减少I/O开销。
- **向量化执行引擎**：批量处理数据，充分利用CPU缓存，加速计算。
- **并行计算**：支持在单机多核、分布式多节点环境下并行执行查询。
- **数据压缩**：每列可根据数据类型选择不同压缩算法，极大降低存储空间。
- **容错机制**：分布式部署下，节点之间有副本，可以实现高可用。
- **近实时查询**：支持秒级数据可见，快速响应复杂查询请求。
- **灵活表引擎**：如MergeTree、ReplacingMergeTree、SummingMergeTree、AggregatingMergeTree等，适配不同场景。

## 3. 常用表引擎  
- **MergeTree**：最常用、基础的引擎，支持高效写入、分区、排序和主键索引。
- **ReplacingMergeTree**：在合并时可根据主键去重，适合去重需求的场景。
- **SummingMergeTree**：在合并过程中对指定字段求和，适合累积型数据。
- **AggregatingMergeTree**：存储预聚合的数据，减少实时查询负担。
- **Distributed**：用于分布式集群，将查询分发到多个节点。

## 4. 分区（Partition）与分片（Shard）  
- **分区 Partition**：在单张表内部，通过指定字段（如按天、月）将数据划分成小块，便于管理、加速查询。
- **分片 Shard**：在分布式表中，将数据水平切分到不同节点，每个节点负责一部分数据，实现负载均衡和扩展。

## 5. 物化视图（Materialized View）  
- 物化视图是一个**自动同步更新的预计算表**，通过定义查询逻辑，在原表写入数据时自动生成预处理结果，极大提升查询速度。
- 适用场景：频繁访问同一计算逻辑（如聚合统计、复杂JOIN查询）。

## 6. 数据导入导出  
- **导入**支持：CSV、TSV、JSON、Parquet等多种格式，可以用`INSERT INTO table FORMAT ...`语法快速加载。
- **导出**支持：直接将查询结果输出为标准格式，也可以结合`clickhouse-client`工具或HTTP接口实现。

## 7. 查询优化机制  
- **主键索引**（Sparse Index）：不是每行都有索引，而是每N行记录一个索引，加速范围查询。
- **跳跃式索引**（Skip Index）：为指定列建立轻量索引，在查询时快速跳过无关数据块。
- **预过滤分区/分片裁剪**：查询时自动裁剪不相关的分区和分片，减少扫描量。

## 8. 高可用和容错  
- 通过**ReplicatedMergeTree**类引擎，支持副本机制，保证数据冗余。
- 借助**ZooKeeper**协调服务，管理副本同步、故障转移、节点状态。

## 9. 集群部署要点  
- 集群由多个节点组成，节点分为多个Shard，每个Shard可以有多个Replica。
- 使用`Distributed`表引擎统一查询所有分片的数据。
- 网络要求：节点之间保持低延迟、高带宽通信，推荐内网环境部署。

## 10. 典型应用场景  
- 网站、APP日志分析  
- 广告点击流数据分析  
- 物联网大数据监控  
- 电商、金融风控数据实时统计  
- 实时看板和运营报表

## 11. 常见问题与注意事项  
- **高并发写入时控制批量大小**，避免小批量频繁写入导致 Merge 负载过高。
- **及时管理旧分区数据**，可以使用TTL策略自动清理过期数据。
- **合理设计分区键和排序键**，避免导致单分区或单节点热点。
- **资源监控**：注意CPU、内存、磁盘I/O和Merge频率，合理调优系统配置。

